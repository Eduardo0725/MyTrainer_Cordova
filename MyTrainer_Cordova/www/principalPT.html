<!DOCTYPE html>
<html>

<head>
	<link rel="shortcut icon" href="img/logo.ico" type="image/x-icon" />
	<meta charset="UTF-8">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">

	<script src="api/api.js"></script>

	<script src="utils/redirect.js"></script>

	<title> Meus Treinos </title>
	<link rel="stylesheet" type="text/css" href="css/principalPT.css">
	<style>
		body {
			background-color: #fff;
		}
	</style>

	<script>

		//A função "sair()" apaga as variáveis (itens) que tem as informações do usuario e sai da página principal para a página inicial.
		function sair(){
            localStorage.removeItem("usuario_id");
            localStorage.removeItem("usuario_email");
			localStorage.removeItem("usuario_tipo");
			
			//O a função "redirect(action, method)" apenas cria um form vazio para poder trocar de página.
            return redirect('index.html', 'post');
		}
		
		//A função "validar()" verifica se os dados do usuario estão armazenados no dispositivo, 
		//se tiver começa a buscar o resto das informações do usuário no banco de dados,
		//senão vai iniciar a função "sair()".
		async function validar() {
			if(localStorage.getItem("usuario_email") && localStorage.getItem("usuario_id")){
				let email = localStorage.getItem("usuario_email"); //Essa variável email só é usada para mostrar no "console.log()"
				usuario_id = localStorage.getItem("usuario_id");
				console.log("id => " + usuario_id + "\nemail => " + email);

				//A função "findData(collection, id)" busca informações do usuario no banco de dados, e é passada para a variável "info".
				info = await findData("personal", usuario_id);
	
				//Caso o "info" estiver vazio é pq ouve algum erro na requisição dos dados então iniciará a função "sair()",
				//senão retorna a inicialização da função "send_position(id)".
				if (!info) {
					alert("Email não conectado!");
					sair();
				} else {
					return send_position(usuario_id);
				}

			} else {
				alert("Email não conectado!");
				sair();
			}
		}

		//A função "formatting_date()" vai formatar a data atual e retornará ela.
		function formatting_date(){

			data = new Date;

			let visto_por_ultimo = [
				{
					dia: data.getDate(),
					mes: data.getMonth() + 1,
					ano: data.getFullYear()
				},
				{
					hora: data.getHours(),
					min: data.getMinutes(),
					seg: data.getSeconds(),
				}
			];

			return visto_por_ultimo;
		}

		//A função "send_date(id, visto_por_ultimo)" envia a ultima vez que o usuario esteve online.
		function send_date(id, visto_por_ultimo){

			//A variável "httpHeaders" serve para montar o um objeto para ser colocado no "headers".
    		//A variável "myHeaders" recebe uma classe "Headers()" para montar o "headers" usando o objeto "httpHeaders". 
			let httpHeaders = { 'Content-Type' : 'application/json', 'Accept-Charset' : 'utf-8' };
			let myHeaders = new Headers(httpHeaders);

			fetch('https://us-central1-pw3-pam2-bd3-01.cloudfunctions.net/last_personal_access',{

					method: 'POST',
					body: JSON.stringify({ 
						"id": id,
						"visto_por_ultimo": visto_por_ultimo
					}),
					headers: myHeaders,
					mode: 'cors',
					cache: 'default'

			}).then(response => {

				return response.json();

			}).then(response => {

				console.log(response);

			})
		}

		//A função "send_position(id)" envia a posição e a hora atual, 
		//e ativa o data_acesso ("setInterval(function, "milisegundos")") para ativar "formatting_date()" e o "send_date(id, visto_por_ultimo) a cada 20.000 milisegundos(20 segundos)".
		async function send_position(id) {

			data_acesso = setInterval(()=>{

				//Pegar a formatação da hora atual.
				visto_por_ultimo = formatting_date();
				console.log(visto_por_ultimo)

				//Envia a data atual.
				send_date(id, visto_por_ultimo);

			},20000) //Os milisegundos
			
			//O "navigator.geolocation.watchPosition" pega a posição atual do usuario, e pega a posição novamente caso o usuario se mova.
			//se conseguir pegar a posição atual vai utilizar o primeiro parametro,
			//senão vai utilizar o segundo transmitindo o erro.
			navigator.geolocation.watchPosition(
				position => {

					//Pega a latitude e a longitude do usuario.
					lat = position.coords.latitude
					lon = position.coords.longitude
					console.log("Latitude => " + lat + "\nLongitude => " + lon);

					let httpHeaders = { 'Content-Type' : 'application/json', 'Accept-Charset' : 'utf-8' };
					let myHeaders = new Headers(httpHeaders);

					//É enviado as coordenadas para o banco de dados.
					fetch('https://us-central1-pw3-pam2-bd3-01.cloudfunctions.net/last_personal_coords',{
						method: 'POST',
						body: JSON.stringify({ 
							id: id,
							latitude : lat,
							longitude : lon
						}),
						headers: myHeaders,
						mode: 'cors',
						cache: 'default'
					}).then(response => {

						return response.json();

					}).then(response => { //Se conseguir enviar a localização, vai enviar tbm a data atual.

						visto_por_ultimo = formatting_date();
						console.log(visto_por_ultimo)

						send_date(id, visto_por_ultimo);
						console.log(response);
					})
				},
				err => { //Caso dê erro ao pegar a localização, vai dá um "alert()" do erro e parar o ciclo do data_acesso.
					alert(err);
					clearInterval(data_acesso);
				}
			);
		}
		
		validar(); //inicia a função

		function verificaTreinos() {
			var treinos = 0;

			if (treinos == 0) {
				document.getElementById("comtreinos").style.display = "none";
				return true;
			}
			else {
				document.getElementById("semtreinos").style.display = "none";
				return true;
			}
		}
	</script>

</head>

<body>
	<div id="comtreinos">
		<div id="treino">
			<div id="imagem">
				<img src="img/perfil.png" height="60px" width="60px"></img>
			</div>

			<div id="dados">
				<p>
					Nome:___________________Idade:__ <br>
					Endereço:_______________________ <br>
					Situação:_______________ <br>
					Início:__/__/_________Horário:__:__ <br>
				</p>
			</div>
		</div>
	</div>

	<div id="semtreinos">
		<br><br><br><br><br><br><br><br><br><br><br><br>
		<center>
			<h2>Você ainda não possuí treinos!</h2>
		</center>
	</div>

	<header>
		<center>
			<h1><b>MEUS TREINOS<b></h1>
		</center>
		<input type="checkbox" id="check">
		<label id="icone" for="check"><img src="img/nav.png" width="30px" height="30px" alt="icone"></label>
		<div class="barra">
			<label id="icone2" for="check"><img src="img/fechar.png" width="40px" height="40px" alt="icone2"></label>
			<br>
			<center>
				<a href=""><img src="img/perfil.png" height="110px" width="110px"></img></a>
				<nav>
					<a href="principalPT.html">
						<div class="link"><br>Meus Treinos</div>
					</a>
					<a href="notificaçõesPT.html">
						<div class="link"><br>Notificações</div>
					</a>
					<a href="meuperfilPT.html">
						<div class="link"><br>Meu Perfil</div>
					</a>
					<a href="faleconoscoPT.html">
						<div class="link"><br>Fale Conosco</div>
					</a>
					<a onclick="sair()">
						<div class="link"><br>Sair</div>
					</a><br>
					<img src="img/logo.png" height="60px" width="60px"></img>
					<h4>Versão 1.0</h4>
				</nav>
			</center>
		</div>
	</header>
</body>

</html>