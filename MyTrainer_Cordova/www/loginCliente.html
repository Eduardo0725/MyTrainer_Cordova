<!DOCTYPE html>
<html>

<head>
	<link rel="shortcut icon" href="img/logo.ico" type="image/x-icon" />
	<meta charset="UTF-8">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
	<title> Login </title>

	<script src="api/api.js"></script>

	<link rel="stylesheet" type="text/css" href="css/logCliente.css">
	<script>

		//A variavel "loading" serve para não repetir a função que ainda esta processando as informações.
		//Usado caso do usuario clicar mais de uma vez no mesmo botão.
		var loading = false;

		//A função "login()" serve para verificar se existe o email, se a senha está correta.
		async function login() {

			//Caso o "loading" seja "true" quer dizer que essa função ainda está em andamento,
			//então vai interromper usando "return" para não ter mais de uma função processando.
			if (loading) {
				return
			}

			loading = true;

			var user = document.getElementById("email").value;
			var pass = document.getElementById("senha").value;

			//Caso um dos campos não sejam preenchidos vai cancelar o procedimento.
			if (user == "" || pass == "") {
				alert("Email ou Senha Inválidos");
				return loading = false;
			}

			//Vai aguardar ("await") o processo de validação terminar e os valores retornados serão passados para a variável "validation".
			await validate("cliente", user, pass).then(validation => {

				//Caso "validation" tenha o valor "erro" quer dizer que ouve um erro na conexão do app com o servidor ou do servidor com o banco de dados.
				if (validation == "erro") {
					alert('Erro na conexão');
					return loading = false;
				}

				//Caso "validation" tenha o valor "false" quer dizer que não encontrou o email solicitado ou a senha esta errada.
				if (!validation) {
					alert("Email ou senha incorretos");
					document.getElementById("email").value = "";
					document.getElementById("senha").value = "";
					return loading = false;
				}

				//Caso "validation" tenha a propriedade "email", armazenha as informações do usuario no dispositivo ("localStorage") e muda para a página de login.
				if (validation.email) {
					localStorage.setItem('usuario_id', validation.id);
					localStorage.setItem('usuario_email', validation.email);
					localStorage.setItem('usuario_tipo', 1); //Cria uma variável "usuario_tipo" com o valor do tipo do usuario. obs: Personal = 0, cliente = 1.
					return document.getElementById('form').submit();
				}

				//Caso "validation" não tenha a propriedade "email" ou valor "false" ou "erro", quer dizer que tem algum erro na estrutura do sistema.
				alert("Erro ao executar a validação.");
				return loading = false;
			});
		}
	</script>
	<style>
		body {
			background: url("img/fundo4.jpg") no-repeat fixed;
			background-size: 100%;
		}

		hr {
			border: 1px solid #000;
		}
	</style>
</head>

<body>
	<form id="form" action="principalCliente.html" method="GET">
		<div class="formulario">
			<center>
				<h3> Já tem conta? <br> Continue conosco! </h3>
				<hr>
				<h3>Email: </h3>
				<input type="text" name="email" id="email" placeholder="  ex: exemplo@email.com"
					size="50"></input><br /></br>
				<h3>Senha: </h3>
				<input type="password" id="senha" placeholder="  ********" size="50"></input><br /><br />
				<br>
				<hr>
				<br>
				<a onclick="login()" id="login">
					<div class="link0">
						<center>Logar
					</div>
				</a> ou
				<a href="cadastroCliente.html">
					<div class="link1">Cadastre-se</div>
				</a>
			</center><br>
		</div>

		<header>
			<center><img src="img/logo4.png" height="60px" width="60px"></center>
			<a href="index.html">
				<div class="voltar"><img src="img/voltar.png" height="25px" width="25px"></img></div>
			</a>
		</header>
	</form>
</body>

</html>