<!DOCTYPE html>
<html>

<head>
	<link rel="shortcut icon" href="img/logo.ico" type="image/x-icon" />
	<meta charset="UTF-8">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">

	<script src="api/Api.js"></script>
	<script src="api/MyTrainerServer.js"></script>

	<script src="utils/Redirect.js"></script>
	<script src="utils/FormattingDate.js"></script>
	<script src="utils/LocalStorage.js"></script>
	<script src="utils/barAndBox.js"></script>

	<title> Meus Treinos </title>
	<link rel="stylesheet" type="text/css" href="css/principalPT.css">
	<link rel="stylesheet" href="./css/barAndBox.css">

	<script>

		var loading = false;

		async function sendTime() {

			if (loading)
				return;

			loading = true;

			let redirect = new Redirect;
			let local = new LocalStorage;
			let data = local.checkUser();

			if (!data) {
				alert("Erro nos dados, entre na conta novamente!");
				local.removeUser();
				redirect.submit("index.html");
			}

			try {
				let myTrainerServer = new MyTrainerServer;
				let state = await myTrainerServer.sendTime(data.id, data.tipo);

				if (!state) {
					throw new Error("Erro no envio dos status!");
				}

				return loading = false;
			} catch (e) {
				console.log(e);
				return loading = false;
			}
		}

		async function sendCoords(){
			let redirect = new Redirect;
			let local = new LocalStorage;
			let data = local.checkUser();

			if (!data) {
				alert("Erro nos dados, entre na conta novamente!");
				local.removeUser();
				redirect.submit("index.html");
			}

			try {
				let myTrainerServer = new MyTrainerServer;
				let state = await myTrainerServer.sendLastSeen(data.id, data.tipo);

				if (!state) {
					throw new Error("Erro no envio das coordenadas!");
				}
			} catch (e) {
				console.log(e);
			}
		}
	</script>

</head>

<body>

	<div class="box hide">
		<a id="close" href="#" onclick="closeBox()"><img src="img/fechar.png" alt="close"></a>
		<div class="content">
			<a href="#"><img src="img/perfil.png" alt="perfil"></a>
			<div id="links">
				<a href="#">Meus Treinos</a>
				<a href="notificaçõesPT.html">Notificações</a>
				<a href="meuperfilPT.html">Meu Perfil</a>
				<a href="faleconoscoPT.html">Trabalhe Conosco</a>
				<a href="#" onclick="exit()">Sair</a>
				<img src="img/logo.png">
				<h4>Versão 1.0</h4>
			</div>
		</div>
	</div>

	<div class="bar">
		<a href="#" onclick="openBox()">
			<img src="img/nav.png" width="30px" height="30px" alt="icone">
		</a>
		<h1>Meus Treinos</h1>
	</div>

	<div id="lista">
		<li>
			<div class="treino">
				<div>
					<p>Musculação</p>
					<p>dd/mm/YYYY</p>
				</div>
				<p>Por: nome do cliente.</p>
			</div>
			<a href="#"><img src="./img/awesome-trash-alt@2x.png" alt="menu"></a>
		</li>
		<li>
			<div class="treino">
				<div>
					<p>Musculação</p>
					<p>dd/mm/YYYY</p>
				</div>
				<p>Por: nome do cliente.</p>
			</div>
			<a href="#"><img src="./img/awesome-trash-alt@2x.png" alt="delete"></a>
		</li>
	</div>

	<script>
		function exit() {
			let local = new LocalStorage;
			let redirect = new Redirect;

			if (!local.removeUser())
				return alert("Erro ao sair");

			redirect.submit('index.html');
		}

		if (!document.querySelector('div#lista li'))
			document.querySelector('div#lista').innerHTML = `
				<div class='empty'>
					<h1>Você ainda não agendou nenhum treino!</h1>
				</div>
			`;

		sendCoords();

		setInterval(() => {
			sendTime();
		}, 20000);
	</script>
</body>

</html>